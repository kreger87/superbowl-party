<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Bowl LX Leaderboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    :root {
      --navy: #002244;
      --green: #69BE28;
      --red: #C60C30;
      --silver: #A5ACAF;
      --dark-bg: #0a0f1a;
      --card-bg: #ffffff;
      --text-primary: #1a1a2e;
      --text-secondary: #555;
      --gold: #FFD700;
      --silver-medal: #C0C0C0;
      --bronze: #CD7F32;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
      background: linear-gradient(135deg, var(--navy) 0%, #001428 50%, #0d1f3c 100%);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(90deg, var(--navy), #001a3a);
      padding: 20px;
      text-align: center;
      border-bottom: 4px solid var(--green);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 20px,
        rgba(105, 190, 40, 0.03) 20px,
        rgba(105, 190, 40, 0.03) 40px
      );
    }

    .header h1 {
      color: #fff;
      font-size: 2rem;
      font-weight: 800;
      position: relative;
      z-index: 1;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .header .subtitle {
      color: var(--silver);
      font-size: 0.9rem;
      margin-top: 4px;
      position: relative;
      z-index: 1;
    }

    /* Tabs */
    .tab-bar {
      display: flex;
      background: rgba(0, 34, 68, 0.95);
      border-bottom: 2px solid rgba(105, 190, 40, 0.3);
    }

    .tab-btn {
      flex: 1;
      padding: 14px 16px;
      background: transparent;
      border: none;
      color: var(--silver);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .tab-btn:hover {
      color: #fff;
      background: rgba(105, 190, 40, 0.1);
    }

    .tab-btn.active {
      color: var(--green);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0; right: 0;
      height: 3px;
      background: var(--green);
    }

    .tab-content {
      display: none;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }

    .tab-content.active {
      display: block;
    }

    /* Leaderboard Tab */
    .leaderboard-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 16px;
    }

    .search-box {
      flex: 1;
      min-width: 180px;
      padding: 10px 14px;
      border: 2px solid rgba(105, 190, 40, 0.3);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.3s;
    }

    .search-box::placeholder {
      color: var(--silver);
    }

    .search-box:focus {
      border-color: var(--green);
    }

    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-refresh {
      background: var(--green);
      color: var(--navy);
    }

    .btn-refresh:hover {
      background: #7cd633;
      transform: translateY(-1px);
    }

    .btn-tv {
      background: var(--red);
      color: #fff;
    }

    .btn-tv:hover {
      background: #e00e36;
      transform: translateY(-1px);
    }

    .btn-tv.active-tv {
      background: var(--green);
      color: var(--navy);
    }

    .refresh-timer {
      color: var(--silver);
      font-size: 0.85rem;
      white-space: nowrap;
    }

    /* Leaderboard Table */
    .leaderboard-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 6px;
    }

    .leaderboard-table thead th {
      color: var(--silver);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 8px 12px;
      text-align: left;
    }

    .leaderboard-table thead th:nth-child(3),
    .leaderboard-table thead th:nth-child(4) {
      text-align: center;
    }

    .leaderboard-row {
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .leaderboard-row:hover {
      background: rgba(255,255,255,0.12);
      transform: scale(1.01);
    }

    .leaderboard-row td {
      padding: 14px 12px;
      color: #e0e0e0;
      font-size: 1rem;
    }

    .leaderboard-row td:first-child {
      border-radius: 10px 0 0 10px;
      width: 60px;
    }

    .leaderboard-row td:last-child {
      border-radius: 0 10px 10px 0;
    }

    .leaderboard-row td:nth-child(3),
    .leaderboard-row td:nth-child(4) {
      text-align: center;
    }

    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-weight: 800;
      font-size: 0.9rem;
    }

    .rank-1 {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #4a3000;
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.4);
    }

    .rank-2 {
      background: linear-gradient(135deg, #e0e0e0, #a0a0a0);
      color: #333;
      box-shadow: 0 0 10px rgba(192, 192, 192, 0.3);
    }

    .rank-3 {
      background: linear-gradient(135deg, #CD7F32, #a0612b);
      color: #fff;
      box-shadow: 0 0 10px rgba(205, 127, 50, 0.3);
    }

    .rank-default {
      background: rgba(255,255,255,0.08);
      color: var(--silver);
    }

    .player-name {
      font-weight: 600;
    }

    .score-cell {
      font-weight: 800;
      font-size: 1.2rem;
      color: var(--green) !important;
    }

    .correct-cell {
      color: var(--silver) !important;
      font-size: 0.9rem;
    }

    /* Gold/Silver/Bronze row highlights */
    .row-gold { background: rgba(255, 215, 0, 0.08) !important; }
    .row-silver { background: rgba(192, 192, 192, 0.08) !important; }
    .row-bronze { background: rgba(205, 127, 50, 0.08) !important; }

    /* Player detail modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-box {
      background: #111827;
      border-radius: 16px;
      padding: 24px;
      max-width: 600px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      border: 2px solid rgba(105, 190, 40, 0.3);
      position: relative;
    }

    .modal-box h2 {
      color: #fff;
      margin-bottom: 4px;
      font-size: 1.4rem;
    }

    .modal-box .modal-subtitle {
      color: var(--green);
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 16px;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .modal-close:hover {
      background: rgba(255,255,255,0.2);
    }

    .picks-grid {
      display: grid;
      gap: 8px;
    }

    .pick-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      align-items: center;
    }

    .pick-correct {
      background: rgba(105, 190, 40, 0.15);
      border-left: 3px solid var(--green);
    }

    .pick-wrong {
      background: rgba(198, 12, 48, 0.15);
      border-left: 3px solid var(--red);
    }

    .pick-pending {
      background: rgba(165, 172, 175, 0.1);
      border-left: 3px solid var(--silver);
    }

    .pick-row .q-label {
      color: var(--silver);
      font-weight: 600;
      font-size: 0.8rem;
    }

    .pick-row .pick-val {
      color: #e0e0e0;
    }

    .pick-row .answer-val {
      color: #e0e0e0;
    }

    .pick-row .pts-val {
      font-weight: 700;
      text-align: right;
      min-width: 40px;
    }

    .pts-earned {
      color: var(--green);
    }

    .pts-zero {
      color: var(--red);
    }

    .pts-pending {
      color: var(--silver);
    }

    /* My Picks Tab */
    .my-picks-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .my-picks-header h2 {
      color: #fff;
      font-size: 1.5rem;
    }

    .my-picks-header .my-score {
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--green);
      margin: 8px 0;
    }

    .my-picks-header .my-correct {
      color: var(--silver);
      font-size: 0.95rem;
    }

    .name-picker-section {
      text-align: center;
      padding: 30px 20px;
      max-width: 400px;
      margin: 0 auto;
    }

    .name-picker-section p {
      color: var(--silver);
      margin-bottom: 16px;
      font-size: 1rem;
    }

    .name-picker-search {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid rgba(105, 190, 40, 0.3);
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      margin-bottom: 12px;
      font-family: inherit;
    }

    .name-picker-search::placeholder {
      color: var(--silver);
    }

    .name-picker-search:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 3px rgba(105, 190, 40, 0.1);
    }

    .name-picker-list {
      list-style: none;
      max-height: 320px;
      overflow-y: auto;
    }

    .name-picker-list li {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 12px 14px;
      border: 2px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      margin-bottom: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      color: #e0e0e0;
      transition: all 0.15s;
      text-align: left;
    }

    .name-picker-list li::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
      flex-shrink: 0;
    }

    .name-picker-list li:hover {
      border-color: var(--green);
      background: rgba(105, 190, 40, 0.08);
      transform: translateY(-1px);
    }

    .name-picker-empty {
      color: var(--silver);
      font-size: 0.9rem;
      padding: 20px;
    }

    .my-picks-grid {
      display: grid;
      gap: 6px;
    }

    .my-pick-row {
      display: grid;
      grid-template-columns: 1.2fr 1fr 1fr 60px;
      gap: 8px;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      align-items: center;
    }

    .my-pick-row.header-row {
      color: var(--silver);
      font-weight: 700;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      background: transparent !important;
      border-left: 3px solid transparent !important;
    }

    .my-pick-row .col-pts {
      text-align: right;
      font-weight: 700;
    }


    /* Admin Tab */
    .admin-panel {
      display: none;
    }

    .admin-panel.show {
      display: block;
    }

    .admin-section-title {
      color: #fff;
      font-size: 1.3rem;
      font-weight: 800;
    }

    .admin-divider {
      height: 1px;
      background: rgba(255,255,255,0.08);
      margin: 28px 0;
    }

    /* Share Section */
    .admin-share-section {
      margin-bottom: 8px;
    }

    .admin-share-subtitle {
      color: var(--silver);
      font-size: 0.9rem;
      margin-top: 4px;
      margin-bottom: 20px;
    }

    .share-content {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

    .qr-wrapper {
      flex-shrink: 0;
      background: #fff;
      padding: 10px;
      border-radius: 16px;
      line-height: 0;
    }

    .qr-wrapper img, .qr-wrapper canvas {
      border-radius: 8px;
      display: block;
    }

    .share-links {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .share-link-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .share-link-label {
      color: var(--silver);
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .share-link-row {
      display: flex;
      gap: 8px;
    }

    .share-link-input {
      flex: 1;
      min-width: 0;
      padding: 10px 14px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      color: #e0e0e0;
      font-size: 0.85rem;
      font-family: inherit;
      outline: none;
      cursor: pointer;
    }

    .share-link-input:focus {
      border-color: var(--green);
    }

    .btn-copy {
      padding: 10px 16px;
      background: var(--green);
      color: var(--navy);
      border: none;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .btn-copy:hover {
      background: #7cd633;
      transform: translateY(-1px);
    }

    .btn-copy.copied {
      background: rgba(105, 190, 40, 0.2);
      color: var(--green);
    }

    @media (max-width: 600px) {
      .share-content {
        flex-direction: column;
        align-items: center;
      }

      .share-links {
        width: 100%;
      }
    }

    /* Admin Header / Stats */
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .admin-stats {
      display: flex;
      gap: 12px;
    }

    .admin-stat {
      background: rgba(255,255,255,0.06);
      padding: 10px 16px;
      border-radius: 12px;
      text-align: center;
    }

    .admin-stat .stat-val {
      color: var(--green);
      font-size: 1.3rem;
      font-weight: 800;
    }

    .admin-stat .stat-label {
      color: var(--silver);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Answer Form */
    .admin-form-grid {
      display: grid;
      gap: 10px;
    }

    .admin-q-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      background: rgba(255,255,255,0.04);
      padding: 14px 16px;
      border-radius: 14px;
      align-items: center;
      transition: background 0.15s;
    }

    .admin-q-row:hover {
      background: rgba(255,255,255,0.06);
    }

    .admin-q-label {
      color: #e0e0e0;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .admin-q-label span {
      color: var(--silver);
      font-size: 0.8rem;
      font-weight: 400;
    }

    .admin-select {
      padding: 11px 14px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      color: #fff;
      font-size: 0.95rem;
      cursor: pointer;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23A5ACAF' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 34px;
      transition: border-color 0.15s;
    }

    .admin-select:focus {
      border-color: var(--green);
    }

    .admin-select option {
      background: #1a1a2e;
      color: #fff;
    }

    .admin-checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .admin-checkbox-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
      color: #e0e0e0;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.15s;
      user-select: none;
    }

    .admin-checkbox-group label:hover {
      border-color: rgba(105, 190, 40, 0.4);
      background: rgba(105, 190, 40, 0.06);
    }

    .admin-checkbox-group input[type="checkbox"] {
      accent-color: var(--green);
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .admin-checkbox-group label.checked {
      border-color: var(--green);
      background: rgba(105, 190, 40, 0.12);
      color: #fff;
    }

    .btn-save-answers {
      background: var(--silver);
      color: #555;
      padding: 14px 36px;
      border: none;
      border-radius: 14px;
      font-weight: 800;
      font-size: 1.1rem;
      cursor: not-allowed;
      margin-top: 16px;
      width: 100%;
      transition: all 0.2s;
      pointer-events: none;
      opacity: 0.6;
      font-family: inherit;
    }

    .btn-save-answers.dirty {
      background: var(--green);
      color: var(--navy);
      cursor: pointer;
      pointer-events: auto;
      opacity: 1;
    }

    .btn-save-answers.dirty:hover {
      background: #7cd633;
      transform: translateY(-1px);
    }

    .btn-reset-answers {
      background: transparent;
      color: var(--silver);
      border: 2px solid rgba(165, 172, 175, 0.2);
      padding: 12px 36px;
      border-radius: 14px;
      font-weight: 700;
      font-size: 0.95rem;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn-reset-answers:hover {
      border-color: var(--red);
      color: var(--red);
    }

    .save-confirm {
      text-align: center;
      padding: 12px;
      margin-top: 12px;
      border-radius: 12px;
      font-weight: 600;
      display: none;
    }

    .save-confirm.success {
      display: block;
      background: rgba(105, 190, 40, 0.15);
      color: var(--green);
    }

    .save-confirm.error {
      display: block;
      background: rgba(198, 12, 48, 0.15);
      color: var(--red);
    }

    /* Submitted Players */
    .admin-players-section {
      margin-top: 28px;
      padding-top: 24px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .admin-players-title {
      color: #fff;
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .admin-player-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 16px;
      background: rgba(255,255,255,0.04);
      border-radius: 12px;
      margin-bottom: 6px;
      transition: background 0.15s;
    }

    .admin-player-row:hover {
      background: rgba(255,255,255,0.07);
    }

    .admin-player-row .player-name {
      color: #e0e0e0;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .btn-delete-pick {
      background: transparent;
      border: 1.5px solid rgba(198, 12, 48, 0.3);
      color: var(--red);
      padding: 6px 14px;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }

    .btn-delete-pick:hover {
      background: rgba(198, 12, 48, 0.12);
      border-color: var(--red);
    }

    /* TV Mode */
    body.tv-mode {
      background: #000;
    }

    body.tv-mode .header {
      padding: 30px;
      border-bottom-width: 6px;
    }

    body.tv-mode .header h1 {
      font-size: 3.5rem;
    }

    body.tv-mode .tab-bar {
      display: none;
    }

    body.tv-mode .tab-content {
      max-width: 100%;
      padding: 30px 40px;
    }

    body.tv-mode .search-box {
      display: none;
    }

    body.tv-mode .leaderboard-controls {
      justify-content: center;
    }

    body.tv-mode .leaderboard-table thead th {
      font-size: 1.2rem;
      padding: 14px 20px;
    }

    body.tv-mode .leaderboard-row td {
      padding: 22px 20px;
      font-size: 1.6rem;
    }

    body.tv-mode .rank-badge {
      width: 56px;
      height: 56px;
      font-size: 1.4rem;
    }

    body.tv-mode .score-cell {
      font-size: 2rem;
    }

    body.tv-mode .refresh-timer {
      font-size: 1.1rem;
    }

    body.tv-mode .btn {
      font-size: 1.1rem;
      padding: 14px 24px;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    body.tv-mode .leaderboard-row {
      animation: slideIn 0.4s ease-out both;
    }

    body.tv-mode .leaderboard-row:nth-child(1) { animation-delay: 0.05s; }
    body.tv-mode .leaderboard-row:nth-child(2) { animation-delay: 0.1s; }
    body.tv-mode .leaderboard-row:nth-child(3) { animation-delay: 0.15s; }
    body.tv-mode .leaderboard-row:nth-child(4) { animation-delay: 0.2s; }
    body.tv-mode .leaderboard-row:nth-child(5) { animation-delay: 0.25s; }
    body.tv-mode .leaderboard-row:nth-child(6) { animation-delay: 0.3s; }
    body.tv-mode .leaderboard-row:nth-child(7) { animation-delay: 0.35s; }
    body.tv-mode .leaderboard-row:nth-child(8) { animation-delay: 0.4s; }
    body.tv-mode .leaderboard-row:nth-child(9) { animation-delay: 0.45s; }
    body.tv-mode .leaderboard-row:nth-child(10) { animation-delay: 0.5s; }

    /* Loading */
    .loading {
      text-align: center;
      color: var(--silver);
      padding: 40px;
      font-size: 1rem;
    }

    .loading .spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid rgba(105, 190, 40, 0.2);
      border-top-color: var(--green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .no-data {
      text-align: center;
      color: var(--silver);
      padding: 40px;
      font-size: 1rem;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .header h1 { font-size: 1.4rem; }
      .tab-btn { font-size: 0.85rem; padding: 12px 8px; }
      .tab-content { padding: 14px; }
      .leaderboard-row td { padding: 10px 8px; font-size: 0.9rem; }
      .rank-badge { width: 30px; height: 30px; font-size: 0.75rem; }
      .pick-row { grid-template-columns: 1fr 1fr; gap: 4px; }
      .pick-row .answer-val { display: none; }
      .my-pick-row { grid-template-columns: 1fr 0.8fr 0.8fr 50px; font-size: 0.8rem; }
      .admin-q-row { grid-template-columns: 1fr; }
      .modal-box { padding: 16px; }
      .admin-stats { flex-direction: column; gap: 8px; }
    }

    /* Party Selector */
    .party-gate {
      text-align: center;
      padding: 3rem 1.5rem;
      max-width: 500px;
      margin: 0 auto;
    }

    .party-gate h2 {
      color: #fff;
      font-size: 1.6rem;
      font-weight: 800;
      margin-bottom: 0.3rem;
    }

    .party-gate .party-subtitle {
      color: var(--silver);
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }

    .party-gate .party-search {
      width: 100%;
      padding: 0.85rem 1.1rem;
      border: 2px solid rgba(105, 190, 40, 0.3);
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      color: #fff;
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      margin-bottom: 0.75rem;
    }

    .party-gate .party-search::placeholder {
      color: var(--silver);
    }

    .party-gate .party-search:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 3px rgba(105, 190, 40, 0.1);
    }

    .party-gate .party-list {
      list-style: none;
      max-height: 260px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }

    .party-gate .party-list li {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.85rem 1rem;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      color: #e0e0e0;
      transition: all 0.15s;
      text-align: left;
    }

    .party-gate .party-list li::before {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--green);
      flex-shrink: 0;
    }

    .party-gate .party-list li:hover {
      border-color: var(--green);
      background: rgba(105, 190, 40, 0.08);
      transform: translateY(-1px);
    }

    .party-gate .party-or-divider {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin: 0.75rem 0;
      color: var(--silver);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .party-gate .party-or-divider::before,
    .party-gate .party-or-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(255,255,255,0.1);
    }

    .party-gate .party-create-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--green);
      color: var(--navy);
      border: none;
      padding: 0.85rem 1.8rem;
      border-radius: 50px;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(105, 190, 40, 0.3);
    }

    .party-gate .party-create-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(105, 190, 40, 0.4);
    }

    .party-gate .party-create-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .party-gate .party-error {
      color: var(--red);
      font-size: 0.9rem;
      font-weight: 500;
      margin-top: 0.75rem;
      display: none;
    }

    .party-gate .party-error.visible {
      display: block;
    }

    /* Create Party Modal (leaderboard, dark theme) */
    .lb-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }

    .lb-modal-overlay.show {
      display: flex;
    }

    .lb-modal-box {
      background: #111827;
      border: 2px solid rgba(105, 190, 40, 0.3);
      border-radius: 20px;
      padding: 2rem;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      animation: lbModalSlideIn 0.25s ease;
    }

    @keyframes lbModalSlideIn {
      from { opacity: 0; transform: translateY(12px) scale(0.97); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .lb-modal-box h3 {
      font-size: 1.25rem;
      font-weight: 800;
      color: #fff;
      margin-bottom: 0.4rem;
    }

    .lb-modal-box p {
      color: var(--silver);
      font-size: 0.9rem;
      margin-bottom: 1.25rem;
    }

    .lb-modal-box .modal-input {
      width: 100%;
      padding: 0.85rem 1rem;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      color: #fff;
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      margin-bottom: 1rem;
    }

    .lb-modal-box .modal-input::placeholder {
      color: var(--silver);
    }

    .lb-modal-box .modal-input:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 3px rgba(105, 190, 40, 0.1);
    }

    .lb-modal-box .modal-actions {
      display: flex;
      gap: 0.75rem;
    }

    .lb-modal-box .btn-cancel {
      flex: 1;
      padding: 0.75rem;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      background: transparent;
      color: var(--silver);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }

    .lb-modal-box .btn-cancel:hover {
      border-color: rgba(255,255,255,0.2);
      color: #fff;
    }

    .lb-modal-box .btn-confirm {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 12px;
      background: var(--green);
      color: var(--navy);
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }

    .lb-modal-box .btn-confirm:hover {
      background: #7cd633;
    }

    .lb-modal-box .btn-confirm:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .lb-modal-box .modal-error {
      color: var(--red);
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.75rem;
      display: none;
    }

    .lb-modal-box .modal-error.visible {
      display: block;
    }

    /* Onboarding Modal */
    .onboarding-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 1001;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }

    .onboarding-overlay.show {
      display: flex;
    }

    .onboarding-box {
      background: #111827;
      border: 2px solid rgba(105, 190, 40, 0.3);
      border-radius: 20px;
      padding: 2rem;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: lbModalSlideIn 0.3s ease;
      text-align: center;
    }

    .onboarding-box h2 {
      color: #fff;
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 0.25rem;
    }

    .onboarding-box .onboarding-subtitle {
      color: var(--silver);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }

    .onboarding-qr {
      display: inline-block;
      background: #fff;
      padding: 10px;
      border-radius: 16px;
      line-height: 0;
      margin-bottom: 1rem;
    }

    .onboarding-qr img, .onboarding-qr canvas {
      border-radius: 8px;
      display: block;
    }

    .onboarding-share-row {
      display: flex;
      gap: 8px;
      margin-bottom: 1.25rem;
    }

    .onboarding-share-row input {
      flex: 1;
      min-width: 0;
      padding: 10px 14px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      color: #e0e0e0;
      font-size: 0.85rem;
      font-family: inherit;
      outline: none;
      cursor: pointer;
    }

    .onboarding-share-row input:focus {
      border-color: var(--green);
    }

    .onboarding-tips {
      text-align: left;
      background: rgba(255,255,255,0.04);
      border-radius: 14px;
      padding: 14px 18px;
      margin-bottom: 1.5rem;
    }

    .onboarding-tips-title {
      color: var(--green);
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .onboarding-tips ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .onboarding-tips li {
      color: #c8c8d0;
      font-size: 0.88rem;
      line-height: 1.5;
      padding: 4px 0;
      padding-left: 1.2em;
      position: relative;
    }

    .onboarding-tips li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 11px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
    }

    .onboarding-tips strong {
      color: #fff;
    }

    .btn-onboarding-done {
      background: var(--green);
      color: var(--navy);
      border: none;
      padding: 14px 36px;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(105, 190, 40, 0.3);
    }

    .btn-onboarding-done:hover {
      background: #7cd633;
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(105, 190, 40, 0.4);
    }

    @media (max-width: 600px) {
      .onboarding-box { padding: 1.5rem; }
      .onboarding-box h2 { font-size: 1.3rem; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(105, 190, 40, 0.3); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(105, 190, 40, 0.5); }
  </style>
</head>
<body>

  <div class="header">
    <h1>Super Bowl LX Leaderboard &#127942;</h1>
    <div class="subtitle">Seahawks vs Patriots &bull; Feb 9, 2026<span id="header-party-name"></span></div>
  </div>

  <!-- Party Gate (shown when no party selected) -->
  <div id="party-gate" class="party-gate" style="display:none;">
    <h2>Select a Party</h2>
    <p class="party-subtitle">Choose your party to view the leaderboard</p>
    <input type="text" class="party-search" id="lb-party-search" placeholder="Search parties..." autocomplete="off" />
    <ul class="party-list" id="lb-party-list"></ul>
    <div class="party-or-divider">or</div>
    <button class="party-create-btn" id="lb-party-create-btn">+ Create New Party</button>
    <div class="party-error" id="lb-party-error"></div>
  </div>

  <!-- Create Party Modal (dark) -->
  <div class="lb-modal-overlay" id="lb-create-party-modal">
    <div class="lb-modal-box">
      <h3>Create a Party</h3>
      <p>Give your party a name that your guests will recognize.</p>
      <div class="modal-error" id="lb-modal-error"></div>
      <input type="text" class="modal-input" id="lb-modal-party-name" placeholder="e.g. The Johnson's Super Bowl Bash" autocomplete="off" />
      <div class="modal-actions">
        <button class="btn-cancel" id="lb-modal-cancel">Cancel</button>
        <button class="btn-confirm" id="lb-modal-confirm">Create Party</button>
      </div>
    </div>
  </div>

  <!-- Onboarding Modal (shown after party creation) -->
  <div class="onboarding-overlay" id="onboardingModal">
    <div class="onboarding-box">
      <h2>Party created!</h2>
      <p class="onboarding-subtitle">Share this with your guests so they can submit picks</p>
      <div class="onboarding-qr" id="onboardingQr"></div>
      <div class="onboarding-share-row">
        <input type="text" id="onboardingShareUrl" readonly />
        <button class="btn-copy" id="onboardingCopyBtn">Copy</button>
      </div>
      <div class="onboarding-tips">
        <div class="onboarding-tips-title">Admin tab</div>
        <ul>
          <li>Scores update automatically &mdash; no need to enter answers</li>
          <li>Remove players and re-share the link anytime</li>
          <li>QR code and share links live there too</li>
        </ul>
      </div>
      <button class="btn-onboarding-done" id="onboardingDoneBtn">Got it</button>
    </div>
  </div>

  <!-- Main content (hidden until party selected) -->
  <div id="main-content">
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="leaderboard">Leaderboard</button>
    <button class="tab-btn" data-tab="mypicks">My Picks</button>
    <button class="tab-btn" data-tab="admin" id="adminTabBtn" style="display:none">Admin</button>
  </div>

  <!-- TAB 1: Leaderboard -->
  <div class="tab-content active" id="tab-leaderboard">
    <div class="leaderboard-controls">
      <input type="text" class="search-box" id="searchBox" placeholder="Search by name..." autocomplete="off">
      <button class="btn btn-refresh" id="btnRefresh">Refresh</button>
      <button class="btn btn-tv" id="btnTV">TV Mode</button>
      <span class="refresh-timer" id="refreshTimer">Next refresh in 30s</span>
    </div>
    <div id="leaderboardArea">
      <div class="loading"><div class="spinner"></div><br>Loading leaderboard...</div>
    </div>
  </div>

  <!-- TAB 2: My Picks -->
  <div class="tab-content" id="tab-mypicks">
    <div id="myPicksArea">
      <div class="loading"><div class="spinner"></div><br>Loading your picks...</div>
    </div>
  </div>

  <!-- TAB 3: Admin -->
  <div class="tab-content" id="tab-admin">
    <div class="admin-panel" id="adminPanel">

      <!-- Share Section -->
      <div class="admin-share-section">
        <h2 class="admin-section-title">Share Your Party</h2>
        <p class="admin-share-subtitle">Guests scan the QR code or tap the link to join</p>
        <div class="share-content">
          <div class="qr-wrapper" id="qrCode"></div>
          <div class="share-links">
            <div class="share-link-group">
              <label class="share-link-label">Picks Form</label>
              <div class="share-link-row">
                <input type="text" class="share-link-input" id="sharePicksUrl" readonly />
                <button class="btn-copy" data-target="sharePicksUrl">Copy</button>
              </div>
            </div>
            <div class="share-link-group">
              <label class="share-link-label">Leaderboard</label>
              <div class="share-link-row">
                <input type="text" class="share-link-input" id="shareLeaderboardUrl" readonly />
                <button class="btn-copy" data-target="shareLeaderboardUrl">Copy</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="admin-divider"></div>

      <!-- Answers Section -->
      <div class="admin-header">
        <h2 class="admin-section-title">Set Correct Answers</h2>
        <div class="admin-stats">
          <div class="admin-stat">
            <div class="stat-val" id="statAnswered">0/16</div>
            <div class="stat-label">Answered</div>
          </div>
          <div class="admin-stat">
            <div class="stat-val" id="statSubmissions">0</div>
            <div class="stat-label">Submissions</div>
          </div>
        </div>
      </div>
      <div class="admin-form-grid" id="adminForm"></div>
      <button class="btn-save-answers" id="btnSaveAnswers">Save Answers</button>
      <button class="btn-reset-answers" id="btnResetAnswers">Reset All Answers</button>
      <div class="save-confirm" id="saveConfirm"></div>

      <div class="admin-players-section">
        <h3 class="admin-players-title">Submitted Players</h3>
        <div id="adminPlayersList"></div>
      </div>
    </div>
  </div>

  </div><!-- /main-content -->

  <!-- Player Detail Modal -->
  <div class="modal-overlay" id="playerModal">
    <div class="modal-box">
      <button class="modal-close" id="modalClose">&times;</button>
      <h2 id="modalPlayerName"></h2>
      <div class="modal-subtitle" id="modalPlayerScore"></div>
      <div class="picks-grid" id="modalPicksGrid"></div>
    </div>
  </div>

<script>
// ============================================================
// CONFIG
// ============================================================
const SUPABASE_URL = 'https://qwyphndhccvisrhkufvz.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_247YYeO-v6NH4_8B8WC8bA_0hfFrr9O';

// ============================================================
// MULTI-SELECT QUESTIONS (admin can pick multiple correct answers)
// ============================================================
const MULTI_SELECT_QUESTIONS = new Set(['q8', 'q16']);

// ============================================================
// POINT VALUES
// ============================================================
const POINT_VALUES = {
  q1: { "Heads": 1, "Tails": 1 },
  q2: { "Over 2 min": 2, "Under 2 min": 2 },
  q3: { "Beer": 2, "Tech": 2, "Food": 3, "Movie Trailer": 3, "Other": 5 },
  q4: { "Seahawks": 2, "Patriots": 3 },
  q5: { "Kenneth Walker III": 3, "Jaxon Smith-Njigba": 3, "Rhamondre Stevenson": 5, "Hunter Henry": 7, "Stefon Diggs": 7, "Other": 10 },
  q6: { "Over 22.5": 2, "Under 22.5": 2 },
  q7: { "Titi Me Pregunto": 2, "DtMF": 3, "Baile Inolvidable": 5, "Monaco": 5, "Other": 7 },
  q8: { "Cardi B": 1, "Rosalia": 5, "Karol G": 5, "No Guest": 7, "Other": 10 },
  q9: { "Sam Darnold": 2, "Drake Maye": 3 },
  q10: { "Yes": 5, "No": 1 },
  q11: { "Over 45.5": 2, "Under 45.5": 2 },
  q12: { "Under 49.5 yds": 2, "Over 49.5 yds": 3 },
  q13: { "Seahawks": 2, "Patriots": 3 },
  q14: { "Sam Darnold": 2, "Drake Maye": 3, "Kenneth Walker III": 5, "Jaxon Smith-Njigba": 5, "Other": 7 },
  q15: { "Orange": 2, "Yellow/Green": 3, "Blue": 3, "Purple": 5, "Red/Pink": 7, "None/Clear": 7 },
  q16: { "Kenneth Walker III": 1, "Jaxon Smith-Njigba": 2, "Rhamondre Stevenson": 2, "Hunter Henry": 3, "AJ Barner": 3, "Stefon Diggs": 3, "Cooper Kupp": 3, "Drake Maye": 3, "Kayshon Boutte": 4, "Rashid Shaheed": 4, "Sam Darnold": 7, "Other": 10 }
};

// ============================================================
// QUESTION LABELS
// ============================================================
const QUESTIONS = {
  q1: "Coin Toss",
  q2: "National Anthem Length",
  q3: "First Commercial",
  q4: "First Team to Score",
  q5: "First TD Scorer",
  q6: "First Half Total Points",
  q7: "Bad Bunny's First Song",
  q8: "Halftime Guest",
  q9: "QB Throws For More Yards",
  q10: "Defensive/ST TD?",
  q11: "Total Game Points",
  q12: "Longest Field Goal",
  q13: "Super Bowl Winner",
  q14: "Super Bowl MVP",
  q15: "Gatorade Color",
  q16: "Anytime TD Scorer"
};

// ============================================================
// ADMIN OPTIONS (must match form exactly)
// ============================================================
const OPTIONS = {
  q1: ["Heads", "Tails"],
  q2: ["Over 2 min", "Under 2 min"],
  q3: ["Beer", "Tech", "Food", "Movie Trailer", "Other"],
  q4: ["Seahawks", "Patriots"],
  q5: ["Kenneth Walker III", "Jaxon Smith-Njigba", "Rhamondre Stevenson", "Hunter Henry", "Stefon Diggs", "Other"],
  q6: ["Over 22.5", "Under 22.5"],
  q7: ["Titi Me Pregunto", "DtMF", "Baile Inolvidable", "Monaco", "Other"],
  q8: ["Cardi B", "Rosalia", "Karol G", "No Guest", "Other"],
  q9: ["Sam Darnold", "Drake Maye"],
  q10: ["Yes", "No"],
  q11: ["Over 45.5", "Under 45.5"],
  q12: ["Under 49.5 yds", "Over 49.5 yds"],
  q13: ["Seahawks", "Patriots"],
  q14: ["Sam Darnold", "Drake Maye", "Kenneth Walker III", "Jaxon Smith-Njigba", "Other"],
  q15: ["Orange", "Yellow/Green", "Blue", "Purple", "Red/Pink", "None/Clear"],
  q16: ["Kenneth Walker III", "Jaxon Smith-Njigba", "Rhamondre Stevenson", "Hunter Henry", "AJ Barner", "Stefon Diggs", "Cooper Kupp", "Drake Maye", "Kayshon Boutte", "Rashid Shaheed", "Sam Darnold", "Other"]
};

// ============================================================
// INIT SUPABASE
// ============================================================
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ============================================================
// STATE
// ============================================================
let allPicks = [];
let currentAnswers = {};
let leaderboardData = [];
let refreshInterval = null;
let countdown = 30;
let tvMode = false;

// ============================================================
// PARTY GATE
// ============================================================
let partyId = localStorage.getItem('sbPartyId');
let partyDisplayName = localStorage.getItem('sbPartyDisplayName');

(async function initPartyGate() {
  // Clear old integer-format party IDs (pre-UUID migration)
  if (partyId && /^\d+$/.test(partyId)) {
    localStorage.removeItem('sbPartyId');
    localStorage.removeItem('sbPartyDisplayName');
    localStorage.removeItem('sbPartyName');
    location.reload();
    return;
  }

  const urlParams = new URLSearchParams(window.location.search);

  // Handle ?admin=TOKEN — store creator token
  const adminToken = urlParams.get('admin');
  if (adminToken) {
    const targetParty = urlParams.get('party') || partyId;
    if (targetParty) {
      const tokens = JSON.parse(localStorage.getItem('sbCreatorTokens') || '{}');
      tokens[targetParty] = adminToken;
      localStorage.setItem('sbCreatorTokens', JSON.stringify(tokens));
    }
  }

  // Handle ?party=UUID deep link
  const partyParam = urlParams.get('party');
  if (partyParam && partyParam !== partyId) {
    const { data } = await supabaseClient
      .from('parties')
      .select('id, name')
      .eq('id', partyParam)
      .single();
    if (data) {
      localStorage.setItem('sbPartyId', data.id);
      localStorage.setItem('sbPartyDisplayName', data.name);
      partyId = data.id;
      partyDisplayName = data.name;
    }
  }

  // Strip URL params
  if (urlParams.has('party') || urlParams.has('admin')) {
    window.history.replaceState({}, '', window.location.pathname);
  }

  if (!partyId) {
    document.getElementById('party-gate').style.display = 'block';
    document.getElementById('main-content').style.display = 'none';
    loadLbParties();
    return;
  }

  // Show party name in header
  document.getElementById('header-party-name').textContent = ' \u2022 ' + partyDisplayName;

  // Check if user is creator (has valid token) — show admin tab
  const tokens = JSON.parse(localStorage.getItem('sbCreatorTokens') || '{}');
  const myToken = tokens[partyId];
  if (myToken) {
    try {
      const { data: isCreator } = await supabaseClient.rpc('verify_creator_token', {
        p_party_id: partyId,
        p_token: myToken
      });
      if (isCreator) {
        document.getElementById('adminTabBtn').style.display = '';
      }
    } catch (err) {
      console.error('Error verifying creator token:', err);
    }
  }

  // Show onboarding modal for first-time admins
  const isAdmin = document.getElementById('adminTabBtn').style.display !== 'none';
  const onboardedKey = 'sbOnboarded_' + partyId;
  if (isAdmin && !localStorage.getItem(onboardedKey)) {
    localStorage.setItem(onboardedKey, '1');
    showOnboardingModal();
  }

  // Start data fetch and refresh timer now that partyId is confirmed
  fetchData();
  startRefreshTimer();
})();

let lbAllParties = [];

async function loadLbParties() {
  const { data, error } = await supabaseClient
    .from('parties')
    .select('id, name, created_at')
    .order('name');

  if (error) {
    console.error('Error loading parties:', error);
    return;
  }
  lbAllParties = data || [];
  renderLbPartyList();
}

function renderLbPartyList() {
  const searchInput = document.getElementById('lb-party-search');
  const list = document.getElementById('lb-party-list');
  const search = searchInput.value.trim().toLowerCase();
  const filtered = search
    ? lbAllParties.filter(p => p.name.toLowerCase().includes(search))
    : lbAllParties;

  list.innerHTML = '';
  filtered.forEach(function (party) {
    const li = document.createElement('li');
    li.textContent = party.name;
    li.addEventListener('click', function () {
      localStorage.setItem('sbPartyId', party.id);
      localStorage.setItem('sbPartyDisplayName', party.name);
      location.reload();
    });
    list.appendChild(li);
  });
}

document.getElementById('lb-party-search').addEventListener('input', renderLbPartyList);

// Create Party Modal (leaderboard)
const lbCreateModal = document.getElementById('lb-create-party-modal');
const lbModalNameInput = document.getElementById('lb-modal-party-name');
const lbModalConfirmBtn = document.getElementById('lb-modal-confirm');
const lbModalCancelBtn = document.getElementById('lb-modal-cancel');
const lbModalErrorEl = document.getElementById('lb-modal-error');

document.getElementById('lb-party-create-btn').addEventListener('click', function () {
  lbModalNameInput.value = document.getElementById('lb-party-search').value.trim();
  lbModalErrorEl.classList.remove('visible');
  lbCreateModal.classList.add('show');
  setTimeout(() => lbModalNameInput.focus(), 100);
});

lbModalCancelBtn.addEventListener('click', function () {
  lbCreateModal.classList.remove('show');
});

lbCreateModal.addEventListener('click', function (e) {
  if (e.target === lbCreateModal) lbCreateModal.classList.remove('show');
});

lbModalNameInput.addEventListener('keydown', function (e) {
  if (e.key === 'Enter') doLbCreateParty();
});

lbModalConfirmBtn.addEventListener('click', doLbCreateParty);

async function doLbCreateParty() {
  const name = lbModalNameInput.value.trim();
  if (!name) {
    showLbModalError('Please enter a party name');
    lbModalNameInput.focus();
    return;
  }

  hideLbModalError();
  lbModalConfirmBtn.disabled = true;
  lbModalConfirmBtn.textContent = 'Creating...';

  try {
    const { data: partyRows, error: partyError } = await supabaseClient
      .rpc('create_party', { p_name: name });

    if (partyError) {
      if (partyError.code === '23505') {
        showLbModalError('A party with that name already exists!');
        return;
      }
      throw partyError;
    }

    const partyData = partyRows[0];

    // Save creator token for admin access
    const tokens = JSON.parse(localStorage.getItem('sbCreatorTokens') || '{}');
    tokens[partyData.id] = partyData.creator_token;
    localStorage.setItem('sbCreatorTokens', JSON.stringify(tokens));

    localStorage.setItem('sbPartyId', partyData.id);
    localStorage.setItem('sbPartyDisplayName', partyData.name);
    location.reload();
  } catch (err) {
    console.error('Error creating party:', err);
    showLbModalError('Error: ' + (err.message || 'Unknown error'));
  } finally {
    lbModalConfirmBtn.disabled = false;
    lbModalConfirmBtn.textContent = 'Create Party';
  }
}

function showLbModalError(msg) {
  lbModalErrorEl.textContent = msg;
  lbModalErrorEl.classList.add('visible');
}

function hideLbModalError() {
  lbModalErrorEl.textContent = '';
  lbModalErrorEl.classList.remove('visible');
}

// ============================================================
// ONBOARDING MODAL
// ============================================================
function showOnboardingModal() {
  const origin = window.location.origin;
  const basePath = window.location.pathname.replace(/\/[^/]*$/, '/');
  const picksUrl = origin + basePath + 'index.html?party=' + partyId;

  // Set share URL
  document.getElementById('onboardingShareUrl').value = picksUrl;

  // Generate QR code
  const qrContainer = document.getElementById('onboardingQr');
  qrContainer.innerHTML = '';
  new QRCode(qrContainer, {
    text: picksUrl,
    width: 180,
    height: 180,
    colorDark: '#002244',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.M
  });

  document.getElementById('onboardingModal').classList.add('show');
}

document.getElementById('onboardingCopyBtn').addEventListener('click', function () {
  const input = document.getElementById('onboardingShareUrl');
  navigator.clipboard.writeText(input.value).then(() => {
    const btn = this;
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.textContent = 'Copy';
      btn.classList.remove('copied');
    }, 2000);
  });
});

document.getElementById('onboardingDoneBtn').addEventListener('click', function () {
  document.getElementById('onboardingModal').classList.remove('show');
});

document.getElementById('onboardingModal').addEventListener('click', function (e) {
  if (e.target === this) this.classList.remove('show');
});

// ============================================================
// TABS
// ============================================================
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    if (tvMode) return;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');

    if (btn.dataset.tab === 'mypicks') renderMyPicks();
    if (btn.dataset.tab === 'admin') checkAdminAuth();
  });
});

// ============================================================
// SCORING LOGIC
// ============================================================
function calculateScores(picks, answers) {
  const results = picks.map(p => {
    let score = 0;
    let correct = 0;
    let total = 0;

    for (let i = 1; i <= 16; i++) {
      const key = 'q' + i;
      if (answers[key] && answers[key] !== '') {
        total++;
        const isCorrect = MULTI_SELECT_QUESTIONS.has(key)
          ? (p[key] && answers[key].split(',').includes(p[key]))
          : (p[key] && p[key] === answers[key]);
        if (isCorrect) {
          correct++;
          const pts = POINT_VALUES[key] && POINT_VALUES[key][p[key]];
          if (pts) score += pts;
        }
      }
    }

    return {
      name: p.name,
      score,
      correct,
      total,
      picks: p
    };
  });

  results.sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    return b.correct - a.correct;
  });

  return results;
}

// ============================================================
// DATA FETCHING (party-scoped)
// ============================================================
async function fetchData() {
  if (!partyId) return;

  try {
    const [picksRes, answersRes] = await Promise.all([
      supabaseClient.from('party_picks').select('*').eq('party_id', partyId),
      supabaseClient.from('party_answers').select('*').eq('party_id', partyId).single()
    ]);

    if (picksRes.data) allPicks = picksRes.data;
    if (answersRes.data) currentAnswers = answersRes.data;

    leaderboardData = calculateScores(allPicks, currentAnswers);
    renderLeaderboard();
  } catch (err) {
    console.error('Fetch error:', err);
  }
}

// ============================================================
// LEADERBOARD RENDERING
// ============================================================
function renderLeaderboard() {
  const area = document.getElementById('leaderboardArea');
  const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();

  let data = leaderboardData;
  if (searchTerm) {
    data = data.filter(d => d.name.toLowerCase().includes(searchTerm));
  }
  if (tvMode) {
    data = data.slice(0, 10);
  }

  if (data.length === 0) {
    area.innerHTML = '<div class="no-data">No players found</div>';
    return;
  }

  // Assign ranks based on full leaderboard (not filtered)
  const rankMap = new Map();
  let currentRank = 0;
  let lastScore = -1;
  let lastCorrect = -1;
  leaderboardData.forEach((d, i) => {
    if (d.score !== lastScore || d.correct !== lastCorrect) {
      currentRank = i + 1;
    }
    lastScore = d.score;
    lastCorrect = d.correct;
    rankMap.set(d.name, currentRank);
  });

  let html = `
    <table class="leaderboard-table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Name</th>
          <th>Score</th>
          <th>Correct</th>
        </tr>
      </thead>
      <tbody>
  `;

  data.forEach(d => {
    const rank = rankMap.get(d.name) || '-';
    let rankClass = 'rank-default';
    let rowClass = '';
    if (rank === 1) { rankClass = 'rank-1'; rowClass = 'row-gold'; }
    else if (rank === 2) { rankClass = 'rank-2'; rowClass = 'row-silver'; }
    else if (rank === 3) { rankClass = 'rank-3'; rowClass = 'row-bronze'; }

    html += `
      <tr class="leaderboard-row ${rowClass}" data-name="${escapeHtml(d.name)}" onclick="showPlayerDetail('${escapeJs(d.name)}')">
        <td><span class="rank-badge ${rankClass}">${rank}</span></td>
        <td class="player-name">${escapeHtml(d.name)}</td>
        <td class="score-cell">${d.score}</td>
        <td class="correct-cell">${d.correct}/${d.total > 0 ? d.total : 16}</td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  area.innerHTML = html;
}

// ============================================================
// PLAYER DETAIL MODAL
// ============================================================
function showPlayerDetail(name) {
  const player = leaderboardData.find(d => d.name === name);
  if (!player) return;

  document.getElementById('modalPlayerName').textContent = player.name;
  document.getElementById('modalPlayerScore').textContent = `${player.score} pts | ${player.correct} correct`;

  const grid = document.getElementById('modalPicksGrid');
  let html = '';

  for (let i = 1; i <= 16; i++) {
    const key = 'q' + i;
    const pick = player.picks[key] || '(no pick)';
    const answer = currentAnswers[key] || '';
    const label = QUESTIONS[key];

    let rowClass = 'pick-pending';
    let ptsText = '--';
    let ptsClass = 'pts-pending';

    if (answer) {
      const isCorrect = MULTI_SELECT_QUESTIONS.has(key)
        ? (pick !== '(no pick)' && answer.split(',').includes(pick))
        : (pick === answer);
      if (isCorrect) {
        rowClass = 'pick-correct';
        const pts = POINT_VALUES[key] && POINT_VALUES[key][pick] ? POINT_VALUES[key][pick] : 0;
        ptsText = '+' + pts;
        ptsClass = 'pts-earned';
      } else {
        rowClass = 'pick-wrong';
        ptsText = '0';
        ptsClass = 'pts-zero';
      }
    }

    const displayAnswer = answer
      ? (MULTI_SELECT_QUESTIONS.has(key) ? escapeHtml(answer.split(',').join(', ')) : escapeHtml(answer))
      : '(pending)';

    html += `
      <div class="pick-row ${rowClass}">
        <div class="q-label">${label}</div>
        <div class="pick-val">${escapeHtml(pick)}</div>
        <div class="answer-val">${displayAnswer}</div>
        <div class="pts-val ${ptsClass}">${ptsText}</div>
      </div>
    `;
  }

  grid.innerHTML = html;
  document.getElementById('playerModal').classList.add('show');
}

document.getElementById('modalClose').addEventListener('click', () => {
  document.getElementById('playerModal').classList.remove('show');
});

document.getElementById('playerModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('playerModal')) {
    document.getElementById('playerModal').classList.remove('show');
  }
});

// ============================================================
// SEARCH
// ============================================================
document.getElementById('searchBox').addEventListener('input', () => {
  renderLeaderboard();
});

// ============================================================
// AUTO REFRESH
// ============================================================
function startRefreshTimer() {
  countdown = 30;
  updateTimerDisplay();
  clearInterval(refreshInterval);
  refreshInterval = setInterval(() => {
    countdown--;
    updateTimerDisplay();
    if (countdown <= 0) {
      fetchData();
      countdown = 30;
    }
  }, 1000);
}

function updateTimerDisplay() {
  document.getElementById('refreshTimer').textContent = `Next refresh in ${countdown}s`;
}

document.getElementById('btnRefresh').addEventListener('click', () => {
  fetchData();
  countdown = 30;
});

// ============================================================
// TV MODE
// ============================================================
document.getElementById('btnTV').addEventListener('click', () => {
  tvMode = !tvMode;
  document.body.classList.toggle('tv-mode', tvMode);
  document.getElementById('btnTV').classList.toggle('active-tv', tvMode);
  document.getElementById('btnTV').textContent = tvMode ? 'Exit TV' : 'TV Mode';

  if (tvMode) {
    // Force leaderboard tab active
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelector('[data-tab="leaderboard"]').classList.add('active');
    document.getElementById('tab-leaderboard').classList.add('active');
  }

  renderLeaderboard();
});

// ============================================================
// MY PICKS TAB
// ============================================================
function renderMyPicks() {
  const area = document.getElementById('myPicksArea');
  const savedName = localStorage.getItem('sbPartyName');

  if (!savedName) {
    renderNamePicker(area, 'Select your name to view your picks:');
    return;
  }

  // Find this player
  const player = leaderboardData.find(d => d.name.toLowerCase() === savedName.toLowerCase());

  if (!player) {
    renderNamePicker(area, `Could not find "${escapeHtml(savedName)}". Select your name:`);
    return;
  }

  let html = `
    <div class="my-picks-header">
      <h2>${escapeHtml(player.name)}</h2>
      <div class="my-score">${player.score} pts</div>
      <div class="my-correct">${player.correct} correct out of ${player.total > 0 ? player.total : 16} answered</div>
    </div>
    <div class="my-picks-grid">
      <div class="my-pick-row header-row pick-pending" style="border-left-color: transparent;">
        <div>Question</div>
        <div>Your Pick</div>
        <div>Correct</div>
        <div class="col-pts">Pts</div>
      </div>
  `;

  for (let i = 1; i <= 16; i++) {
    const key = 'q' + i;
    const pick = player.picks[key] || '(no pick)';
    const answer = currentAnswers[key] || '';
    const label = QUESTIONS[key];

    let rowClass = 'pick-pending';
    let ptsText = '--';

    if (answer) {
      const isCorrect = MULTI_SELECT_QUESTIONS.has(key)
        ? (pick !== '(no pick)' && answer.split(',').includes(pick))
        : (pick === answer);
      if (isCorrect) {
        rowClass = 'pick-correct';
        const pts = POINT_VALUES[key] && POINT_VALUES[key][pick] ? POINT_VALUES[key][pick] : 0;
        ptsText = '+' + pts;
      } else {
        rowClass = 'pick-wrong';
        ptsText = '0';
      }
    }

    const myDisplayAnswer = answer
      ? (MULTI_SELECT_QUESTIONS.has(key) ? escapeHtml(answer.split(',').join(', ')) : escapeHtml(answer))
      : '(pending)';
    const isMyCorrect = answer && (MULTI_SELECT_QUESTIONS.has(key)
      ? (pick !== '(no pick)' && answer.split(',').includes(pick))
      : (pick === answer));

    html += `
      <div class="my-pick-row ${rowClass}">
        <div style="font-weight:600; color: var(--silver);">${label}</div>
        <div style="color:#e0e0e0;">${escapeHtml(pick)}</div>
        <div style="color:#e0e0e0;">${myDisplayAnswer}</div>
        <div class="col-pts" style="color: ${answer ? (isMyCorrect ? 'var(--green)' : 'var(--red)') : 'var(--silver)'};">${ptsText}</div>
      </div>
    `;
  }

  html += '</div>';
  area.innerHTML = html;
}

function renderNamePicker(area, message) {
  const names = allPicks.map(p => p.name).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

  if (names.length === 0) {
    area.innerHTML = `<div class="name-picker-section"><p>No picks submitted yet for this party.</p></div>`;
    return;
  }

  area.innerHTML = `
    <div class="name-picker-section">
      <p>${message}</p>
      <input type="text" class="name-picker-search" id="namePickerSearch" placeholder="Filter names..." autocomplete="off">
      <ul class="name-picker-list" id="namePickerList"></ul>
    </div>
  `;

  function renderList() {
    const list = document.getElementById('namePickerList');
    const filter = document.getElementById('namePickerSearch').value.trim().toLowerCase();
    const filtered = filter ? names.filter(n => n.toLowerCase().includes(filter)) : names;

    list.innerHTML = '';
    if (filtered.length === 0) {
      list.innerHTML = '<div class="name-picker-empty">No matching names</div>';
      return;
    }
    filtered.forEach(function (name) {
      const li = document.createElement('li');
      li.textContent = name;
      li.addEventListener('click', function () {
        localStorage.setItem('sbPartyName', name);
        renderMyPicks();
      });
      list.appendChild(li);
    });
  }

  renderList();
  document.getElementById('namePickerSearch').addEventListener('input', renderList);
}

// ============================================================
// ADMIN TAB (creator-token-based)
// ============================================================
function checkAdminAuth() {
  showAdminPanel();
}

function showAdminPanel() {
  document.getElementById('adminPanel').classList.add('show');
  buildAdminForm();
  updateAdminStats();
  renderAdminPlayers();
  renderShareSection();
}

function renderShareSection() {
  const origin = window.location.origin;
  const basePath = window.location.pathname.replace(/\/[^/]*$/, '/');
  const picksUrl = origin + basePath + 'index.html?party=' + partyId;
  const leaderboardUrl = origin + basePath + 'leaderboard.html?party=' + partyId;

  document.getElementById('sharePicksUrl').value = picksUrl;
  document.getElementById('shareLeaderboardUrl').value = leaderboardUrl;

  // Generate QR code for picks URL
  const qrContainer = document.getElementById('qrCode');
  qrContainer.innerHTML = '';
  new QRCode(qrContainer, {
    text: picksUrl,
    width: 160,
    height: 160,
    colorDark: '#002244',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.M
  });

  // Copy button handlers
  document.querySelectorAll('.btn-copy').forEach(btn => {
    btn.addEventListener('click', function () {
      const input = document.getElementById(this.dataset.target);
      navigator.clipboard.writeText(input.value).then(() => {
        const original = this.textContent;
        this.textContent = 'Copied!';
        this.classList.add('copied');
        setTimeout(() => {
          this.textContent = original;
          this.classList.remove('copied');
        }, 2000);
      });
    });
  });
}

function renderAdminPlayers() {
  const container = document.getElementById('adminPlayersList');
  const sorted = [...allPicks].sort((a, b) =>
    a.name.toLowerCase().localeCompare(b.name.toLowerCase())
  );

  if (sorted.length === 0) {
    container.innerHTML = '<div style="color:var(--silver); font-size:0.9rem; padding:12px 0;">No players have submitted picks yet.</div>';
    return;
  }

  container.innerHTML = sorted.map(pick => `
    <div class="admin-player-row">
      <span class="player-name">${escapeHtml(pick.name)}</span>
      <button class="btn-delete-pick" data-pick-id="${pick.id}" data-pick-name="${escapeHtml(pick.name)}">Remove</button>
    </div>
  `).join('');

  container.querySelectorAll('.btn-delete-pick').forEach(btn => {
    btn.addEventListener('click', async function () {
      const pickId = this.dataset.pickId;
      const pickName = this.dataset.pickName;
      if (!window.confirm('Remove all picks for "' + pickName + '"? This cannot be undone.')) return;

      this.disabled = true;
      this.textContent = 'Removing...';

      try {
        const { error } = await supabaseClient
          .from('party_picks')
          .delete()
          .eq('id', pickId);

        if (error) throw error;

        // Refresh data
        await fetchData();
        renderAdminPlayers();
        updateAdminStats();
      } catch (err) {
        console.error('Delete error:', err);
        alert('Error removing player: ' + (err.message || 'Unknown error'));
        this.disabled = false;
        this.textContent = 'Remove';
      }
    });
  });
}

let savedAdminState = {};

function snapshotAdminState() {
  savedAdminState = {};
  for (let i = 1; i <= 16; i++) {
    const key = 'q' + i;
    savedAdminState[key] = currentAnswers[key] || '';
  }
}

function getCheckboxValue(key) {
  const group = document.getElementById('admin-' + key);
  if (!group) return '';
  const checked = Array.from(group.querySelectorAll('input[type="checkbox"]:checked'));
  return checked.map(cb => cb.value).join(',');
}

function checkAdminDirty() {
  const btn = document.getElementById('btnSaveAnswers');
  let dirty = false;
  for (let i = 1; i <= 16; i++) {
    const key = 'q' + i;
    if (MULTI_SELECT_QUESTIONS.has(key)) {
      if (getCheckboxValue(key) !== (savedAdminState[key] || '')) {
        dirty = true;
        break;
      }
    } else {
      const sel = document.getElementById('admin-' + key);
      if (sel && sel.value !== (savedAdminState[key] || '')) {
        dirty = true;
        break;
      }
    }
  }
  btn.classList.toggle('dirty', dirty);
}

function buildAdminForm() {
  const form = document.getElementById('adminForm');
  snapshotAdminState();
  let html = '';

  for (let i = 1; i <= 16; i++) {
    const key = 'q' + i;
    const label = QUESTIONS[key];
    const opts = OPTIONS[key];
    const currentVal = currentAnswers[key] || '';

    if (MULTI_SELECT_QUESTIONS.has(key)) {
      // Multi-select checkboxes (multiple correct answers)
      const checkedVals = currentVal ? currentVal.split(',') : [];
      html += `
        <div class="admin-q-row" style="grid-template-columns: 1fr;">
          <div class="admin-q-label">
            Q${i}: ${label}
            <br><span>${opts.map(o => {
              const pts = POINT_VALUES[key][o];
              return o + ' (' + pts + 'pt' + (pts > 1 ? 's' : '') + ')';
            }).join(', ')}</span>
          </div>
          <div class="admin-checkbox-group" id="admin-${key}">
            ${opts.map(o => {
              const isChecked = checkedVals.includes(o);
              return `<label class="${isChecked ? 'checked' : ''}"><input type="checkbox" name="admin-${key}" value="${escapeHtml(o)}" ${isChecked ? 'checked' : ''} />${escapeHtml(o)}</label>`;
            }).join('')}
          </div>
        </div>
      `;
    } else {
      html += `
        <div class="admin-q-row">
          <div class="admin-q-label">
            Q${i}: ${label}
            <br><span>${opts.map(o => {
              const pts = POINT_VALUES[key][o];
              return o + ' (' + pts + 'pt' + (pts > 1 ? 's' : '') + ')';
            }).join(', ')}</span>
          </div>
          <select class="admin-select" id="admin-${key}" data-key="${key}">
            <option value="">(Not yet)</option>
            ${opts.map(o => `<option value="${escapeHtml(o)}" ${currentVal === o ? 'selected' : ''}>${escapeHtml(o)}</option>`).join('')}
          </select>
        </div>
      `;
    }
  }

  form.innerHTML = html;

  // Listen for changes on all selects
  form.querySelectorAll('.admin-select').forEach(sel => {
    sel.addEventListener('change', checkAdminDirty);
  });

  // Listen for multi-select checkbox changes
  MULTI_SELECT_QUESTIONS.forEach(qKey => {
    const group = document.getElementById('admin-' + qKey);
    if (group) {
      group.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', function () {
          this.closest('label').classList.toggle('checked', this.checked);
          checkAdminDirty();
        });
      });
    }
  });

  checkAdminDirty();
}

function updateAdminStats() {
  let answered = 0;
  for (let i = 1; i <= 16; i++) {
    if (currentAnswers['q' + i] && currentAnswers['q' + i] !== '') answered++;
  }
  document.getElementById('statAnswered').textContent = `${answered}/16`;
  document.getElementById('statSubmissions').textContent = allPicks.length;
}

document.getElementById('btnSaveAnswers').addEventListener('click', async () => {
  const btn = document.getElementById('btnSaveAnswers');
  const confirmEl = document.getElementById('saveConfirm');
  btn.classList.remove('dirty');
  btn.textContent = 'Saving...';
  confirmEl.className = 'save-confirm';
  confirmEl.style.display = 'none';

  const updateObj = {};
  for (let i = 1; i <= 16; i++) {
    const key = 'q' + i;
    if (MULTI_SELECT_QUESTIONS.has(key)) {
      const val = getCheckboxValue(key);
      updateObj[key] = val || null;
    } else {
      const sel = document.getElementById('admin-' + key);
      updateObj[key] = sel.value || null;
    }
  }

  try {
    const { error } = await supabaseClient
      .from('party_answers')
      .update(updateObj)
      .neq('party_id', '00000000-0000-0000-0000-000000000000');

    if (error) throw error;

    // Update local state and snapshot
    Object.assign(currentAnswers, updateObj);
    snapshotAdminState();
    leaderboardData = calculateScores(allPicks, currentAnswers);
    updateAdminStats();

    confirmEl.textContent = 'Answers saved successfully!';
    confirmEl.className = 'save-confirm success';
  } catch (err) {
    console.error('Save error:', err);
    confirmEl.textContent = 'Error saving answers: ' + (err.message || 'Unknown error');
    confirmEl.className = 'save-confirm error';
  } finally {
    btn.textContent = 'Save Answers';
    checkAdminDirty();
    setTimeout(() => {
      confirmEl.style.display = 'none';
      confirmEl.className = 'save-confirm';
    }, 4000);
  }
});

// Reset all answers
document.getElementById('btnResetAnswers').addEventListener('click', async () => {
  if (!window.confirm('Reset ALL answers to unanswered? This will zero out all scores.')) return;

  const btn = document.getElementById('btnResetAnswers');
  const confirmEl = document.getElementById('saveConfirm');
  btn.disabled = true;
  btn.textContent = 'Resetting...';

  const updateObj = {};
  for (let i = 1; i <= 16; i++) {
    updateObj['q' + i] = null;
  }

  try {
    const { error } = await supabaseClient
      .from('party_answers')
      .update(updateObj)
      .neq('party_id', '00000000-0000-0000-0000-000000000000');

    if (error) throw error;

    Object.assign(currentAnswers, updateObj);
    snapshotAdminState();
    leaderboardData = calculateScores(allPicks, currentAnswers);
    updateAdminStats();
    buildAdminForm();

    confirmEl.textContent = 'All answers reset!';
    confirmEl.className = 'save-confirm success';
  } catch (err) {
    console.error('Reset error:', err);
    confirmEl.textContent = 'Error resetting: ' + (err.message || 'Unknown error');
    confirmEl.className = 'save-confirm error';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Reset All Answers';
    setTimeout(() => {
      confirmEl.style.display = 'none';
      confirmEl.className = 'save-confirm';
    }, 4000);
  }
});

// ============================================================
// UTILITIES
// ============================================================
function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function escapeJs(str) {
  if (!str) return '';
  return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
}

// ============================================================
// INIT
// ============================================================
// Data fetch and refresh timer are started inside initPartyGate() above
</script>

</body>
</html>
